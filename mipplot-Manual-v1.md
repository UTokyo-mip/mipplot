# R _mipplot_ package
***

Developers: Diego SILVA HERRAN <sup>1</sup>
, Jiayang WANG <sup>2</sup>, Masahiro SUGIYAMA <sup>2</sup>, Hiroto SHIRAKI <sup>3</sup>.

1 Institute for Global Environmental Strategies (IGES), Japan.

2 Policy Alternatives Research Insititute (PARI), The University of Tokyo, Japan.

3 The University of Shiga Prefecture, Japan.
***

## Outline 
The mipplot tool produces plots for straightforward visualization of data from climate mitigation scenarios (also known as emission scenarios) generated by means of integrated assessment models (IAM) and energy-economic models. The tool can be applied to any dataset following the format adopted by data submissions contributing to IPCC’s assessment reports.  


## Purpose and Functionality

The mipplot package contains generic functions to produce area/bar/box/line plots of data following IAMC submission format.


## Installation

Install mipplot package from GitHub (requires [devtools](https://github.com/hadley/devtools) package):

```r
if (!require("devtools")) install.packages("devtools")
library(devtools)
devtools::install_github("UTokyo-mip/mipplot", dependencies = TRUE)
```

Need to install mip package from PIK.
For installation of the most recent package version an additional repository has to be added in R:

```r
options(repos = c(CRAN = "@CRAN@", rd3mod_repo = "http://www.pik-potsdam.de/rd3mod/R/"))
```
The additional repository can be made available permanently by adding the line above to a file called `.Rprofile` stored in the home folder of your system (`Sys.glob("~")` in R returns the home directory).

After that the most recent version of the package can be installed using `install.packages`:

```r
install.packages("mip")
```

Package updates can be installed using `update.packages` (make sure that the additional repository has been added before running that command):

```r
update.packages()
```

# mipplot

Package contains generic functions to produce area/bar/box/line plots of data following IAMC submission format.


## Example

```r
library(mipplot)
mipplot_interactive_plot_line(mipplot::ar5_db_sample09_Wang, mipplot::ar5_db_rule_table_v09_Wang)
```

## Questions / Problems

In case of questions / problems please contact Diego Silva Herran <silva-herran@iges.or.jp>.


## Screenshots

<img src="/images/top_screenshot.png?raw=true" width=70.0% alt="screenshot" />

## License

The mipplot R package is open source licensed under the MIT license.


# Extended Manual 



## 1. Introduction 

This document describes the features of the mipplot tool, a tool for visualizing data from climate mitigation scenarios (also known as emission scenarios) generated by means of integrated assessment models (IAM) and energy-economic models.  The tool is a package of scripts developed in “R” programming language (R version 3.4.0) in the “RStudio” software (version 1.0.143).  It was developed to serve a two-fold purpose: gathering of IAM scenario data into a consistent dataset, and straightforward visualization of key data from multiple models.  The approach adopted in the development of the tool can be potentially applied to any dataset that follows the Integrated Assessment Modeling Consortium (IAMC) data submission format.  This format has been adopted by data submissions contributing to IPCC’s assessment reports.  Moreover, the tool can be delivered as a hands-on tool for non-experts to visualize with minimum effort the information from mitigation scenarios.

## 2. Purpose 

The initial purpose of the mipplot tool is to generate plots from emission scenario data with minimum effort from users. It has been developed assuming that users have little knowledge on the background of the models and methodologies used to generate such data.
This tool uses the data from different models and scenarios generated for model intercomparison comparison (MIP) exercises.  
As such exercises are conducted on the assumption that data by different models is comparable, guaranteeing that the data submitted by all modeling teams are consistent on their own, and comply with a standard format is essential for the analyses.
The tool can be used to check the list of variables submitted and missing, check the additivity of disaggregated variables to their corresponding totals, and generating plots of the variables.


## 3. Tool outline (input/output)


<img src="/images/Fig-Tool_structure-v1.png?raw=true" width=70.0% alt="screenshot" />
 

#### Figure 1  Schematic of the the tool with the flow of information.

### Inputs
* Scenario data file: this file contains all data in the IAMC standard format for data submission based on a list of pre-defined variables.
* Rule table: 	this table lists the variables included in the scenario data, grouped into aggregated and disaggregated variables.  It defines the aggregated variables as “left hand side” variables, and disaggregated variables as “right hand side” variables. 

### Processes
* Set up: install and import libraries.
* Input data preparation: edits the input data to table format suitable for diagnostics and plotting.
* Diagnostic plots: generate plots of the variables submitted.
* Variable submission check: generate list of variables submitted/missing.
* Additivity test: checks the additivity of disaggregated variables to their corresponding totals.

## 4. Outputs 
* Diagnostic plots.
* List of submitted/missing variables.
* Results of the additivity test.



## 5. Software requirements and tool installation
The following softwares are needed for installation and operation of the tool.

### Software
* R programming language: 
This is a software for scripting language. It can be downloaded for free from the [R website](https://www.r-project.org/).

* RStudio
This is a visual interface for developing and executing scripts developed in R language.
It can be downloaded for free from the [RStudio website](https://www.rstudio.com/products/rstudio/download/).

### Installing the package

Some R libraries containing built-in functions are required to install and operate the mipplot tool. 
They can be installed for free via R or RStudio with the following instructions.

Install mipplot package from GitHub (requires [devtools](https://github.com/hadley/devtools) package):

```r
if (!require("devtools")) install.packages("devtools")
library(devtools)
devtools::install_github("UTokyo-mip/mipplot", dependencies = TRUE)
```

mip package from PIK is also needed.
For installation of the most recent package version an additional repository has to be added in R:

```r
options(repos = c(CRAN = "@CRAN@", rd3mod_repo = "http://www.pik-potsdam.de/rd3mod/R/"))
```
The additional repository can be made available permanently by adding the line above to a file called `.Rprofile` stored in the home folder of your system (`Sys.glob("~")` in R returns the home directory).



The mipplot tool is provided as a library or package of R scripts.  
It is installed with the following command:

```r
install.packages("mip")
```

Package updates can be installed using `update.packages` (make sure that the additional repository has been added before running that command):

```r
update.packages()
```


## 6. Tool operation

### Overall workflow
The tool is operated by first reading the input data file, and then by applying any of the plotting and diagnostic functions supported by the tool.  All functions will be applied to the object defined when reading the input data.  As long as all functions are applied to the same input data, and the session in RStudio is not terminated, there is no need to read the input data a second time.  


<img src="/images/Fig-Workflow_operation-v2.png?raw=true" width=70.0% alt="screenshot" />

 
#### Figure 2  Schematic of the workflow for operation of the tool.

### Loading the input data
Read the input data with the readquitte function.  If no file is specified, a sample dataset from the IPCC AR5 scenario database is loaded by default.  

### Creating plots from the input data
Several types of plots based on the input data can be generated.  
The plot types supported by the current version of the tool includes line, stacked area, stacked bar, and boxplot. 
Invoke plotting function
Specify scope of data to plot: scenarios, models, regions, variables, periods (if needed).
Specify plotting options: color, line, facet, etc.
Enable output as pdf file.

### Diagnosing integrity of the input data


### Other operations (forthcoming?)


## 7. Tool structure 
###  Libraries
* The packages (i.e. libraries) necessary for running the tool include “reshape2” (for transforming data tables from/to long to/from wide format), “stringr” (to manipulate strings), “openxlsx” (to read and write spreadsheet files in xlsx format), “ggplots” (to create plots), “data.table” (to read input data files), “dplyr” (to format and processing dataframes),  “tibble” (to format and process dataframes), “readr”. 

### Read and format input data 
* Read and process the input data: This process adopts the quitte function, which transforms an IAMC format data table into a format suitable for applying plotting functions in R programming language. It transform from wide table format (years in columns) to long table format (years as rows and only one column with values). Values in all columns, except for “period” (year) and “value”, are converted into factors.

 
 ```r
mipplot_readquitte (filename = NULL, sep = ",", interactive = FALSE, DEBUG = T)
```

  Example: 

 ```r
mipplot_readquitte(AR5_Sample_data)
```

  Read table of additivity rule and adds column with id number

 ```r
mipplot_read_ruletab (R_without_id)
```

 Example: 

 ```r
mipplot_read_ruletab (R_without_id)
```

### Plotting functions

* **Area plot:** stacked area plots using right-hand-side values of target additivity rule.

```r
mipplot_area ( D, R, region = levels(D$region), scenario = levels(D$scenario),
facet_x = NULL, facet_y = NULL, PRINT_OUT = F, DEBUG = T, fontsize = 20)
```

Example: 

```r
mipplot_area (AR5_Sample_data, AR5_Rule_table)
```

* **Bar plot:** stacked area plots using right-hand-side values of target additivity rule. 

```r
mipplot_box ( D, region = levels(D$region), variable = levels(D$variable), target_year = levels(D$period), PRINT_OUT = F, DEBUG = T)
```

Example: 

```r
mipplot_bar(AR5_Sample_data, AR5_Rule_table)
```

* **Line plot:** line plots of multiple selected scenarios/models.

```r
mipplot_line ( D, region = levels(D$region), variable = levels(D$variable),
  colorby = "scenario", linetypeby = "model", shapeby = "model",
  scenario = levels(D$scenario), facet_x = NULL, facet_y = NULL, PRINT_OUT = F, DEBUG = T)
```

Example: 

```r
mipplot_line(AR5_Sample_data)
```

* **Box plot:** box plots representing spread of data (minimum/maximum values, median, 25th/75th interquartiles, outliers) for a specific period. 

```r
mipplot_box ( D, region = levels(D$region), variable = levels(D$variable),
target_year = levels(D$period), PRINT_OUT = F, DEBUG = T)
```

Example: 

```r
mipplot_box(AR5_Sample_data)
```

### Data diagnostic functions
* **Variable submission check**
 * Compares the variables submitted with a list of default variables.
 * This component gives for each variable in the list the status of “submitted”, or “missing”.
 * Variables in the data submission which are not included in the default list, are marked as “additional”.

```r
mipplot_var_submission (D, V, na_name = "N/A")
```

Example: 

```r
mipplot_var_submission (AR5_Sample_data
```

## References

IAMC AR5 Scenario Database, 2014. Available at: https://secure.iiasa.ac.at/web-apps/ene/AR5DB/

## Appendix

### Rule table AR5 vXX

### AR5 scenario database description

See the Annex ii of the IPCC AR5, and the homepage of the [IPCC AR5 database](https://secure.iiasa.ac.at/web-apps/ene/AR5DB/).


***

